<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タグラグビーXプログラミング | プログラグビー</title>
    <meta
      name="description"
      content="タグラグビーの戦術をプログラミングで考える"
    />
    <meta name="keywords" content="プログラグビー, タグラグビー, AI, 戦術" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="stylesheet" href="assets/css/custom.css" />

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <link rel="stylesheet" href="assets/codemirror/lib/codemirror.css" />
    <script src="assets/codemirror/lib/codemirror.js"></script>
    <script src="assets/codemirror/mode/javascript/javascript.js"></script>
    <link rel="stylesheet" href="assets/codemirror/addon/dialog/dialog.css" />
    <link rel="stylesheet" href="assets/codemirror/addon/search/matchesonscrollbar.css" />
    <script src="assets/codemirror/addon/dialog/dialog.js"></script>
    <script src="assets/codemirror/addon/search/searchcursor.js"></script>
    <script src="assets/codemirror/addon/search/search.js"></script>
    <script src="assets/codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script src="assets/codemirror/addon/search/matchesonscrollbar.js"></script>
    <script src="assets/codemirror/addon/search/jump-to-line.js"></script>
    <link rel="stylesheet" href="assets/codemirror/theme/eclipse.css" />

    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script type="module" src="assets/js/TagRugby-core-v2.js"></script>
  </head>
  <body class="app-body">
    <header class="app-header">
      <nav class="app-nav container-xxl">
        <a class="app-brand" href="#">
          <span class="app-brand__icon">
            <img src="assets/img/rugby-ball.svg" alt="プログラグビー" width="32" height="32" />
          </span>
          <span class="app-brand__label">PROGRUGBY</span>
        </a>
        <div class="app-nav__actions">
          <div class="layout-buttons">
            <button class="btn layout-btn active" type="button" data-layout="auto">
              <span class="material-symbols-outlined">settings</span>
              <span class="layout-btn__label">自動</span>
            </button>
            <button class="btn layout-btn" type="button" data-layout="vertical">
              <span class="material-symbols-outlined">phone_android</span>
              <span class="layout-btn__label">縦積み</span>
            </button>
            <button class="btn layout-btn" type="button" data-layout="fullsize">
              <span class="material-symbols-outlined">desktop_windows</span>
              <span class="layout-btn__label">フルサイズ</span>
            </button>
          </div>
        </div>
      </nav>
    </header>

    <main class="app-main container-xxl" id="studio">
      <div class="row gy-4 align-items-start">
        <div class="col-xxl-8 d-flex flex-column gap-4">
          <section class="glass-panel board-card" aria-labelledby="boardCardTitle">
            <header class="board-card__header">
              <div>
                <span class="eyebrow">Match Canvas</span>
                <h2 id="boardCardTitle">戦術シミュレーター</h2>
              </div>
              <div class="board-card__score">
                <div class="score-chip">
                  <span class="score-chip__label">残りタグ</span>
                  <span class="score-chip__value" id="tag">0</span>
                </div>
                <div class="score-chip__messages">
                  <div class="scoreboard-inline">
                    <div class="scoreboard-header">
                      <span class="scoreboard-label">勝敗メーター</span>
                      <span class="scoreboard-description">試合の勝敗数を表示します</span>
                    </div>
                    <div class="progress scoreboard-progress-inline">
                      <div
                        id="attack_win_num"
                        class="progress-bar bg-progress-attack"
                        role="progressbar"
                        style="width: 50%"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      >
                        攻め手　0 回
                      </div>
                      <div
                        id="defense_win_num"
                        class="progress-bar bg-progress-defense"
                        role="progressbar"
                        style="width: 50%"
                        aria-valuenow="0"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      >
                        守り手　0 回
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </header>
            <div class="board-card__stage boardarea">
              <div id="konva-container"></div>
              <canvas id="canvas" style="display: none;"></canvas>
            </div>
          </section>

          <section class="glass-panel chat-panel" aria-labelledby="chatPanelTitle">
            <header class="panel-header">
              <span class="eyebrow">AI Conversation</span>
              <h2 id="chatPanelTitle">AIに相談する</h2>
            </header>
            <div id="chat-box"></div>
            <div id="loadingIndicator" class="chat-loading" style="display: none;">読み込み中...</div>
            <textarea
              id="input-field"
              class="form-control"
              rows="5"
              placeholder="戦術の疑問や分析のリクエストを入力"
            ></textarea>
            <button type="button" class="btn btn-primary w-100" onclick="sendChat()">
              <span class="material-symbols-outlined">mic</span>
              話しかける
            </button>
          </section>

          <section class="glass-panel code-editor" aria-labelledby="attackEditorTitle">
            <header class="panel-header">
              <span class="eyebrow">AI Code</span>
              <div>
                <h2 id="attackEditorTitle">攻め手AI スクリプト</h2>
                <p>AttackAIを編集して、攻め手AIをプログラミングしましょう。</p>
              </div>
            </header>
            <form name="CodingForm2" class="editor-form">
              <div class="editor-form__group">
                <div class="form-hint" id="codeerror"></div>
                <textarea class="form-control" name="attackAIfunc" rows="18"></textarea>
              </div>
              <div class="row g-3 mt-4">
                <div class="col-md-6">
                  <button
                    type="button"
                    class="btn btn-primary w-100"
                    onclick="window.open('instruction.html', '_blank')"
                  >
                    <span class="material-symbols-outlined">lightbulb</span>
                    マニュアル
                  </button>
                </div>
                <div class="col-md-6">
                  <button type="button" class="btn btn-primary w-100" onclick="save()">
                    <span class="material-symbols-outlined">save</span>
                    AI保存
                  </button>
                </div>
              </div>
            </form>
          </section>

          <section class="glass-panel sample-panel" aria-labelledby="sampleTitle">
            <header class="panel-header">
              <span class="eyebrow">Scenario Presets</span>
              <h2 id="sampleTitle">サンプル読み込み</h2>
            </header>
            <form name="SampleForm" class="control-form">
              <div class="form-grid form-grid--compact">
                <div class="form-field form-field--wide">
                  <label for="samplenum">サンプル</label>
                  <select name="samplenum" id="samplenum" class="form-select">
                    <option value="1">1対1 (1)</option>
                    <option value="2">1対1 (2)</option>
                    <option value="3">1対1 (3)</option>
                    <option value="4">2対2 (1)</option>
                    <option value="5">2対2 (2)</option>
                    <option value="6">2対2 (3)</option>
                  </select>
                </div>
              </div>
              <div class="control-actions mt-3">
                <button type="button" class="btn btn-primary w-100" onclick="sampleset()">
                  <span class="material-symbols-outlined">file_download</span>
                  読み込み
                </button>
              </div>
            </form>
          </section>

          <section class="glass-panel config-panel" aria-labelledby="configTitle">
            <header class="panel-header">
              <span class="eyebrow">Environment</span>
              <h2 id="configTitle">盤面コンフィグ</h2>
            </header>
            <form name="ConfigForm" class="control-form">
              <div class="form-grid form-grid--compact">
                <div class="form-field">
                  <label for="boardsize">盤面サイズ</label>
                  <select name="boardsize" id="boardsize" class="form-select">
                    <option value="8">8×8</option>
                    <option value="12">12×12</option>
                    <option value="16">16×16</option>
                    <option value="20" selected="selected">20×20</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="tag_num">タグの回数</label>
                  <select name="tag_num" id="tag_num" class="form-select">
                    <option value="1">1回</option>
                    <option value="2">2回</option>
                    <option value="3">3回</option>
                    <option value="4" selected="selected">4回</option>
                    <option value="5">5回</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="attackNum">攻め手人数</label>
                  <select name="attackNum" id="attackNum" class="form-select">
                    <option value="1">1人</option>
                    <option value="2">2人</option>
                    <option value="3">3人</option>
                    <option value="4">4人</option>
                    <option value="5" selected="selected">5人</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="defenseNum">守り手人数</label>
                  <select name="defenseNum" id="defenseNum" class="form-select">
                    <option value="1">1人</option>
                    <option value="2">2人</option>
                    <option value="3">3人</option>
                    <option value="4">4人</option>
                    <option value="5" selected="selected">5人</option>
                  </select>
                </div>
              </div>
              <div class="control-actions mt-3">
                <button type="button" class="btn btn-outline-light w-100" onclick="config()">
                  <span class="material-symbols-outlined">settings</span>
                  設定を反映
                </button>
              </div>
              <div class="editor-mode-toggle mt-3">
                <button type="button" class="btn btn-outline-primary w-100" id="togglePositionEditMode">
                  <span class="material-symbols-outlined">edit</span>
                  初期配置編集
                </button>
                <button type="button" class="btn btn-outline-secondary w-100 d-none mt-2" id="savePositionEdit">
                  <span class="material-symbols-outlined">save</span>
                  保存
                </button>
                <button type="button" class="btn btn-outline-secondary w-100 d-none mt-2" id="cancelPositionEdit">
                  <span class="material-symbols-outlined">close</span>
                  キャンセル
                </button>
              </div>
              <div class="position-edit-hint d-none mt-2" id="positionEditHint">
                <small class="text-muted">
                  <span class="material-symbols-outlined">info</span>
                  盤面をクリックすると「空きマス → 攻め手 → 守り手」の順に切り替わります。ボールを持っている攻め手は削除できません。
                </small>
              </div>
            </form>
          </section>
        </div>

        <div class="col-xxl-4 d-flex flex-column gap-4">
          <section class="glass-panel control-panel" aria-labelledby="controlPanelTitle">
            <header class="panel-header">
              <span class="eyebrow">Match Control</span>
              <div>
                <h2 id="controlPanelTitle">ゲーム設定</h2>
              </div>
            </header>
            <form name="ControlForm" class="control-form">
              <div class="form-grid">
                <div class="form-field">
                  <label for="attack_role">攻め手</label>
                  <select name="attack_role" id="attack_role" class="form-select">
                    <option value="human">人</option>
                    <option value="AttackAI">AI</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="defense_role">守り手</label>
                  <select name="defense_role" id="defense_role" class="form-select">
                    <option value="human">人間</option>
                    <option value="DefenseSample1">AI1</option>
                    <option value="DefenseSample2">AI2</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="game_speed">試合スピード</label>
                  <select name="game_speed" id="game_speed" class="form-select">
                    <option value="0">低速</option>
                    <option value="1">高速</option>
                    <option value="2">超高速</option>
                  </select>
                </div>
              </div>
              <div class="control-actions">
                <button type="button" class="btn btn-primary w-100" onclick="restart()">
                  <span class="material-symbols-outlined">play_arrow</span>
                  攻守を更新
                </button>
                <button type="button" class="btn btn-secondary w-100" onclick="config()">
                  <span class="material-symbols-outlined">restart_alt</span>
                  盤面リセット
                </button>
                <input type="hidden" name="ana_role" value="AttackAI" />
                <button type="button" class="btn btn-outline-light w-100" onclick="analysis()">
                  <span class="material-symbols-outlined">monitoring</span>
                  解析（評価値表示）
                </button>
              </div>
            </form>
          </section>

          <section class="glass-panel metrics-panel" aria-labelledby="metricsTitle">
            <header class="panel-header">
              <span class="eyebrow">Realtime Telemetry</span>
              <div>
                <h2 id="metricsTitle">試合パラメータ</h2>
              </div>
            </header>
            <div class="metrics-scroll">
              <ul class="metrics-list list-group list-group-flush">
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('step')">step</button>
                  <span class="param-description">行動回数</span>
                  <span class="badge paramBadge" id="param_step"></span>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('ball')">ball</button>
                  <span class="param-description">ボールを持っているプレイヤーの番号</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_ball_0">0</span>
                    <span class="badge paramBadge" id="param_ball_1">1</span>
                    <span class="badge paramBadge" id="param_ball_2">2</span>
                    <span class="badge paramBadge" id="param_ball_3">3</span>
                    <span class="badge paramBadge" id="param_ball_4">4</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('select')">select</button>
                  <span class="param-description">行動待ちのプレイヤーの番号</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_select_0">0</span>
                    <span class="badge paramBadge" id="param_select_1">1</span>
                    <span class="badge paramBadge" id="param_select_2">2</span>
                    <span class="badge paramBadge" id="param_select_3">3</span>
                    <span class="badge paramBadge" id="param_select_4">4</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('tag')">tag</button>
                  <span class="param-description">残りのタグの数</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_tag_1">1</span>
                    <span class="badge paramBadge" id="param_tag_2">2</span>
                    <span class="badge paramBadge" id="param_tag_3">3</span>
                    <span class="badge paramBadge" id="param_tag_4">4</span>
                    <span class="badge paramBadge" id="param_tag_5">5</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('wait')">wait</button>
                  <span class="param-description">一回休みになっているか</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_wait_1">True(1)</span>
                    <span class="badge paramBadge" id="param_wait_0">False(-1)</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('tagged')">tagged</button>
                  <span class="param-description">タグをとられた直後か</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_tagged_1">True(1)</span>
                    <span class="badge paramBadge" id="param_tagged_0">False(-1)</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('turn')">turn</button>
                  <span class="param-description">攻め手か守り手か</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_turn_1">攻(1)</span>
                    <span class="badge paramBadge" id="param_turn_0">守(-1)</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('distance_defense')">distance_defense</button>
                  <span class="param-description">守り手までの距離</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_distance_0">0</span>
                    <span class="badge paramBadge" id="param_distance_1">1</span>
                    <span class="badge paramBadge" id="param_distance_2">2</span>
                    <span class="badge paramBadge" id="param_distance_3">3</span>
                    <span class="badge paramBadge" id="param_distance_4">4</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('distance_defense_min')">distance_defense_min</button>
                  <span class="param-description">最小の守り手までの距離</span>
                  <span class="badge paramBadge" id="param_distance_defense_min"></span>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('horizontal_diff_from_ball')">horizontal_diff_from_ball</button>
                  <span class="param-description">ボールとの横の距離</span>
                  <span class="badge paramBadge" id="param_horizontal_diff_from_ball"></span>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('vertical_diff_from_ball')">vertical_diff_from_ball</button>
                  <span class="param-description">ボールとの縦の距離</span>
                  <span class="badge paramBadge" id="param_vertical_diff_from_ball"></span>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('defenseLine')">defenseLine</button>
                  <span class="param-description">守り手の左からの順番</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_defenseLine_0">0</span>
                    <span class="badge paramBadge" id="param_defenseLine_1">1</span>
                    <span class="badge paramBadge" id="param_defenseLine_2">2</span>
                    <span class="badge paramBadge" id="param_defenseLine_3">3</span>
                    <span class="badge paramBadge" id="param_defenseLine_4">4</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('attackLine')">attackLine</button>
                  <span class="param-description">攻め手の左からの順番</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_attackLine_0">0</span>
                    <span class="badge paramBadge" id="param_attackLine_1">1</span>
                    <span class="badge paramBadge" id="param_attackLine_2">2</span>
                    <span class="badge paramBadge" id="param_attackLine_3">3</span>
                    <span class="badge paramBadge" id="param_attackLine_4">4</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('deviation_from_uniform_position')">deviation_from_uniform_position</button>
                  <span class="param-description">均等に並ぶ場所からのずれ</span>
                  <span class="badge paramBadge" id="param_deviation_from_uniform_position"></span>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('distance_defense_throw_min')">distance_defense_throw_min</button>
                  <span class="param-description">ボールと守り手の最短距離</span>
                  <span class="badge paramBadge" id="param_distance_defense_throw_min"></span>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('distance_defense_catch_min')">distance_defense_catch_min</button>
                  <span class="param-description">守り手との最短距離</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_distance_defense_catch_min_0">0</span>
                    <span class="badge paramBadge" id="param_distance_defense_catch_min_1">1</span>
                    <span class="badge paramBadge" id="param_distance_defense_catch_min_2">2</span>
                    <span class="badge paramBadge" id="param_distance_defense_catch_min_3">3</span>
                    <span class="badge paramBadge" id="param_distance_defense_catch_min_4">4</span>
                  </div>
                </li>
                <li class="list-group-item metrics-item">
                  <button type="button" class="btn btn-outline-dark btn-sm" onclick="navigator.clipboard.writeText('pass_distance')">pass_distance</button>
                  <span class="param-description">パスの距離</span>
                  <div class="param-item">
                    <span class="badge paramBadge" id="param_pass_distance_0">0</span>
                    <span class="badge paramBadge" id="param_pass_distance_1">1</span>
                    <span class="badge paramBadge" id="param_pass_distance_2">2</span>
                    <span class="badge paramBadge" id="param_pass_distance_3">3</span>
                    <span class="badge paramBadge" id="param_pass_distance_4">4</span>
                  </div>
                </li>
              </ul>
            </div>
          </section>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      <div class="container-xxl d-flex justify-content-center align-items-center flex-wrap gap-3">
        <span>プログラグビー </span>
      </div>
    </footer>

    <script type="text/javascript">
      // レイアウト選択機能
      (function() {
        const layoutButtons = document.querySelectorAll('.layout-btn');
        const mainContent = document.querySelector('.app-main');
        
        // 現在のレイアウトを取得（localStorageから、またはデフォルト）
        let userSelectedLayout = localStorage.getItem('layout') || 'auto';
        
        // 自動レイアウトの判定
        function getAutoLayout() {
          const width = window.innerWidth;
          if (width >= 1400) {
            return 'fullsize';
          } else {
            return 'vertical';
          }
        }
        
        // レイアウトを適用
        function applyLayout(layout) {
          const effectiveLayout = layout === 'auto' ? getAutoLayout() : layout;
          
          console.log(`[Layout] Applying layout: ${layout}, effective: ${effectiveLayout}`);
          
          // アクティブ状態を更新
          layoutButtons.forEach(btn => {
            btn.classList.remove('active');
          });
          
          const selectedButton = document.querySelector(`.layout-btn[data-layout="${layout}"]`);
          if (selectedButton) {
            selectedButton.classList.add('active');
          }
          
          // レイアウトに応じてクラスを適用
          if (mainContent) {
            mainContent.classList.remove('layout-auto', 'layout-vertical', 'layout-fullsize');
            mainContent.classList.add(`layout-${effectiveLayout}`);
            console.log(`[Layout] Main content classes:`, mainContent.className);
            
            // 直接スタイルを適用して確実にレイアウトを変更
            const row = mainContent.querySelector('.row.gy-4');
            const col8 = mainContent.querySelector('.col-xxl-8');
            const col4 = mainContent.querySelector('.col-xxl-4');
            
            if (row && col8 && col4) {
              if (effectiveLayout === 'vertical') {
                // 縦積みレイアウト（1列）
                row.style.flexDirection = 'column';
                col8.style.width = '100%';
                col8.style.maxWidth = '100%';
                col8.style.flex = '0 0 100%';
                col4.style.width = '100%';
                col4.style.maxWidth = '100%';
                col4.style.flex = '0 0 100%';
              } else if (effectiveLayout === 'fullsize') {
                // フルサイズレイアウト（2列 70%/30%）
                row.style.flexDirection = 'row';
                col8.style.width = '70%';
                col8.style.maxWidth = '70%';
                col8.style.flex = '0 0 70%';
                col4.style.width = '30%';
                col4.style.maxWidth = '30%';
                col4.style.flex = '0 0 30%';
              } else {
                // 自動レイアウト（デフォルト）
                row.style.flexDirection = '';
                col8.style.width = '';
                col8.style.maxWidth = '';
                col8.style.flex = '';
                col4.style.width = '';
                col4.style.maxWidth = '';
                col4.style.flex = '';
              }
            }
          }
        }
        
        // 初期レイアウトを適用
        applyLayout(userSelectedLayout);
        
        // ウィンドウリサイズ時に自動レイアウトを再評価
        let resizeTimer;
        window.addEventListener('resize', function() {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(function() {
            if (userSelectedLayout === 'auto') {
              applyLayout('auto');
            }
          }, 250);
        });
        
        // クリックイベント
        layoutButtons.forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            const layout = this.getAttribute('data-layout');
            userSelectedLayout = layout;
            localStorage.setItem('layout', layout);
            applyLayout(layout);
          });
        });
      })();
      
      let editor = CodeMirror.fromTextArea(document.CodingForm2.attackAIfunc, {
        lineNumbers: true,
        mode: "javascript",
        theme: "eclipse",
      });
      editor.setValue(loadAI());
      window.attackEditor = editor;
      window.editor = editor;

      // CodeMirrorエディタは削除（ドラッグ&ドロップ編集に移行）
      // pos_editorは使用しなくなったため、undefinedのまま

      function loadpos() {
        let xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", "assets/js/initial_pos.js", false);
        xmlHttp.send(null);
        return xmlHttp.responseText;
      }

      function loadAI() {
        let xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", "assets/js/attackAI-simple.js", false);
        xmlHttp.send(null);
        return xmlHttp.responseText;
      }
    </script>
    <script src="assets/js/gpt.js"></script>
  </body>
</html>
